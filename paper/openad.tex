\documentclass{article}

\usepackage{wrapfig}
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{wrapfig}
\usepackage[dvips]{epsfig}

\newcommand{\R}{I\!\!R}
\newcommand{\fig}[1]{Figure~#1}

\begin{document}

\begin{center}
{\LARGE \bf OpenAD } \vspace{.2cm} \\

[P. Heimbach, C. Hill, C. Wunsch\footnote{principal investigator}]\footnote{Massachusetts Institute of Technology, Cambridge, MA; Application}, [M. Fagan, N. Tallent]\footnote{Rice University, Houston, TX; Fortran~90 front-end}, 
and [U.~Naumann\footnote{corresp. author, {\tt naumann@mcs.anl.gov}}, J. Utke]\footnote{Argonne National Laboratory / University of Chicago, Argonne, IL; xaif, xaifBooster}
\end{center}

\subsection*{Extended Abstract}

The ``Adjoint Compiler Technology and Standards" (ACTS)
project is a collaborative
research and development effort in automatic differentiation (AD)
\begin{wrapfigure}{r}{6cm}
\epsfig{file=overview.eps,width=6cm}
\caption{The {\bf Open64} front-end performs a lexical, syntactic, and semantic analysis and produces an intermediate representation of $F$ in {\em whirl} format.
{\bf OpenAnalysis} is used to build call and control flow graphs, used by
{\bf whirl2xaif} to construct a representation of the numerical core of $F$ in
{\em xaif} format. A differentiated version of $F_{xaif}$ is derived by an 
algorithm that is built with {\bf xaifBooster}. Both  
$F'_{xaif}$ and $F_{whirl}$ are combined by {\bf xaif2whirl} to construct a 
{\em whirl} representation of the differentiated code. The unparser of 
{\bf Open64}
transforms the latter into Fortran~90. 
} \label{fig:overview}
\end{wrapfigure}
\cite{BBCG96,CFG+01,CG91,Gri00}
focussing on its application and next-generation tool development.
The project involves
oceanographers and chemical engineers at MIT and computer scientists 
at Argonne National Laboratory/University of Chicago and Rice University.
The main result of year one is an open AD 
infrastructure (OpenAD) that has been used to implement tangent-linear
and adjoint code generators. Both algorithms were applied successfully to an
oceanographic box model. 

The specific objectives for the first year of the ACTS project were
as follows:

1. Definition and implementation of a programming language independent 
intermediate representation

2. Provision of a platform for the development of AD algorithms for 
programs given in this intermediate format

3. Adaptation of an existing Fortran~90 front- and back-end to parse into 
this intermediate representation as well as unparse from it into Fortran~90
derivative code 

4. Automatic generation of tangent-linear and adjoint versions of 
an oceanographic box model.

All objectives were met. Refer to {\tt www.autodiff.org/ACTS} for further 
information.
The current state of OpenAD is illustrated in 
\fig{\ref{fig:overview}} together with a brief description of the steps
performed during the semantic transformation of a program $F$ into
a differentiated program $F'$.
The dotted line encloses the language specific front-end that can potentially
be replaced by front-ends for languages other than Fortran. For example, an 
effort running parallel to the ACTS project at Argonne National Laboratory is 
developing a new version of ADIC \cite{HoNo01} by coupling a C/C++ 
front-end 
based on an EDG parser ({\tt www.edg.com}) and uses ROSE in combination with SAGE~3 ({\tt www.llnl.gov/CASC}) as internal representation
with OpenAD.

This paper discusses the components of OpenAD,
including the underlying design decisions, algorithmic aspects, and
numerical results.

\paragraph{xaif} 
An XML-based ({\tt www.w3c.org/XML}) hierarchy of directed graphs, referred to as xaif 
\cite{HNN02}, is used for the 
internal representation of the numerical core of the implementation
of a given vector function. This format is 
well suited to represent the results of  semantic transformations including 
preaccumulation \cite{BiHa96,CDB96,GrRe91} and 
program reversal \cite{Gri92,WaGr01} at various levels (call graph, control 
flow graphs, basic blocks, expressions). 
The main idea behind xaif is to provide a language-independent exchange
format that separates language-specific from transformation-related 
algorithmic issues. Potentially, front-ends for various programming languages 
can utilize xaif, for example, Open64 and EDG/SAGE~3 as pointed out before.

\paragraph{xaifBooster} 

\begin{wrapfigure}{l}{4cm}
\epsfig{file=principle.eps,width=4cm}
\caption{xaifBooster parses xaif code into an internal representation (IR).
It provides an API for transformation algorithms to modify the IR. An unparser
returns the transformed xaif code.} \label{fig:xaifBooster}
\end{wrapfigure}
The C++ code xaifBooster is a collection of utilities and routines for the
(semantic) transformation of programs given in xaif. Its principal architecture 
is illustrated in \fig{\ref{fig:xaifBooster}}. One of the major concerns during
the development of xaifBooster has been the clean separation of the internal
representation (an enhanced object image of xaif) from algorithms that operate 
on this data structure. This goal has been achieved by applying the design 
patterns \cite{DesignPatterns} factory, visitor, and decorator as described in \cite{UtNa03}.
The result is an API that gives AD developers the opportunity
to implement new algorithms in a source transformation environment without
having to implement full compiler front- and back-ends. Building on
this API, we have implemented a tangent-linear algorithm that uses statement-
\cite{SEUpreacc} and basic-block-level preaccumulation of local 
gradients/Jacobians. Near-optimal face elimination \cite{ElimTechMP} sequences 
are computed by the software tool 
ANGEL \cite{AGN03,SAGA} ({\tt angellib.sourceforge.net}) and transformed into 
Jacobian code by
an xaifBooster algorithm. A simple adjoint version of the code is obtained
by taping the local Jacobians 
and by computing the corresponding ``transposed Jacobian-vector" products 
during an interpretive reverse sweep through the tape. This approach is
essentially equivalent to split program reversal \cite{Gri00} and allows
for an easy coupling of tangent-linear and adjoint versions of small to 
medium-sized codes as described in \cite{NaHe03}. 

Details of the automatic generation of adjoint code in split mode are presented
in the full version of the paper. Furthermore, additional information is 
provided on xaifBooster as a platform for implementing new AD algorithms with 
the objective to establish an open quasi-standard development infrastructure
within the AD community.

\paragraph{Fortran~90 front-end} 
The main target application of the ACTS project is the MIT general circulation
model (MITgcm) \cite{mars-eta:97b,mars-eta:97a}. 
It is mostly implemented in Fortran~77 to permit maintenance of an efficient
and correct adjoint as the code evolves \cite{HHG02}. Future development will
increasingly add Fortran~90 features. We use the Fortran~90 
front-end that is part of the Open64 compiler suite 
maintained by the Center for High Performance Software
Research at Rice University 
({\tt hipersoft.cs.rice.edu/Open64/}). It parses
Fortran codes into an intermediate representation called whirl and
provides an unparser from whirl back to Fortran. 
The focus of the ACTS project is on the
transformation of whirl into xaif (whirl2xaif) and, conversely, on the
back-translation of differentiated xaif code into whirl (xaif2whirl). 
whirl2xaif uses the call graph and control flow graph builders that are part 
of the OpenAnalysis\footnote{No documentation is available yet. 
Refer to the Open64 cvs repository under 
{\tt hipersoft.cs.rice.edu/Open64} for information on the code.} 
infrastructure, whose objective is to provide a programming
language-independent platform for the development of data and control flow 
analyses. 

\paragraph{Application}

The reference application for the first prototype of an OpenAD implementation
is a simplified oceanographic box model for investigating
thermohaline circulation. It relates to the
ocean circulation's role in the variability of the climate system,
on time scales of decades to millennia \cite{tzi-ioa:02}.
Previously, the AD tool TAF \cite{GiKa02} 
had been used to generate the derivative
code in both forward and reverse modes.
See \cite{maro-eta:99} for an applications of
TAF's predecessor TAMC to the MITgcm.

OpenAD has been used to generate tangent-linear and 
adjoint versions of the box model. We established numerical identity between
the Jacobians provided by TAF and OpenAD.
The successful 
application of OpenAD to the box model code is considered as a feasibility 
proof for the overall approach taken by the ACTS project.  

\subsection*{Ongoing Work: Reverse Mode}

Ongoing efforts target the automatic generation of efficient adjoint
code by using the reverse mode of AD. Checkpointing is realized at the 
subroutine level allowing for the storage of inputs as well as outputs. 
For each subroutine we generate a version that ``knows" how to store and 
restore its arguments and results, how to run (parts of) itself for a given
set of inputs, and how to tape and immediately adjoin (parts of) itself.
This approach allows for a large number of reversal modes, 
joint mode \cite{Gri00}, and joint mode with subroutine results checkpointing 
representing special cases. 

We expect to have a first version of the reverse mode with checkpointing
running by the end of April. The full paper describes the approach in detail 
and presents numerical results.

\subsection*{Conclusion and Future Work}

OpenAD is an AD tool development infrastructure. Its well-separated components
allow developers to focus on various aspects of source-to-source 
transformation AD, including parsing and unparsing of different programming
languages, data and control flow analysis, and (semantic) transformation 
algorithms. The intention of OpenAD is to provide the AD community with 
an open, extensible, and easy-to-use platform for research and development
in the field. Its intention is not to render obsolete existing source transformation
tools such as ADIFOR,\footnote{{\tt http://www.cs.rice.edu/\~\!adifor}} 
the differentiation-enabled NAG Fortran 95 
compiler,\footnote{{\tt http://www.nag.co.uk/nagware/research/ad\_overview.asp}} TAF,\footnote{{\tt http://www.FastOpt.de}} and TAPENADE.\footnote{{\tt http://tapenade.inria.fr:8080/tapenade/index.jsp}} 
Their closer coupling with the language-specific internal representation of 
the program has the potential to make the
exploitation of certain language features easier. OpenAD is supposed to 
complement these tools by providing well-defined APIs to an open internal 
representation that can be used by a large number of AD developers.
Users of AD technology will benefit from the expected wide
variety of combinations of front-ends and algorithms that is made possible
by OpenAD.

During the remainder of the ACTS project we will focus on the implementation
of robust and efficient data flow algorithms in OpenAnalysis, including alias, 
define-use and use-define, in-out \cite{Muc97}, 
activity, and to-be-recorded \cite{HNP02} as well as on 
the development of various reverse mode algorithms for parallel MPI codes
combining elements such as preaccumulation and (automatic) checkpointing
\cite{Gri92}. 
A second set of target 
applications in chemical engineering \cite{FTB97} requires combinations of first and 
second derivatives in addition to methods for exploiting structure and sparsity
of the underlying computation. We intend to investigate ways to compute these
combinations efficiently by integrating OpenAD into the relevant 
numerical algorithms.

Ultimately, our aim is to generate correct, efficient, scalable, and easily 
maintainable adjoint code for the MITgcm. The major challenge arises from the
requirement to tackle problems in which derivatives are calculated with respect 
to billions of controls. A combination of the methods outlined above is 
essential to guarantee the successful completion of this highly ambitious
project.

\subsection*{Acknowledgements}

Funding for the ACTS project is provided by NSF under ITR contract OCE-0205590
for a three year period that started in September 2002.

Naumann is supported in part by the Mathematical, Information, and Computational
Sciences Division subprogram of the Office of Advanced Scientific Computing
Research, Office of Science, U.S. Department of Energy, under Contract
W-31-109-ENG-38.



\bibliographystyle{plain}
\bibliography{openad}


\end{document}
